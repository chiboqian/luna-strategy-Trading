# Optimized for 1-MINUTE BARS
# RSI 21 = 21 minutes, Z-score 20 = 20 minutes, SMA 50 = 50 min, SMA 200 = 3.3 hours
# Trend cooldown: 10 min (600s), Mean reversion cooldown: 45 min (2700s)
#
# RULE ARCHITECTURE (no overlaps):
# - Trend rules: RSI 42-58, z-score -1.5 to 1.5 (neutral zone)
# - Mean reversion: RSI < 22 OR > 78 WITH z-score confirmation (extremes only)
# - Removed redundant VWAP-only rules to prevent double-dip signals

schedule:
  enabled: true
  timezone: "America/New_York"
  run_on_weekends: false
  windows:
    - "09:30-15:50"

data_feed: iex # Options: iex (free), sip (paid)

rules:
  # ============================================================================
  # SPY TREND RULES
  # ============================================================================

  # Trend Monitor: SPY Uptrend (Price > SMA 50 AND SMA 200)
  # Only buy in confirmed uptrend with RSI in neutral zone and not overextended
  - name: "SPY Uptrend"
    symbol: "SPY"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "close"
        operator: ">"
        value: "sma_50"
      - field: "close"
        operator: ">"
        value: "sma_200"
      - field: "rsi_21"
        operator: "<"
        value: 58.0
      - field: "rsi_21"
        operator: ">"
        value: 42.0
      - field: "z_score_vwap_20"
        operator: "<"
        value: 1.5
      - field: "z_score_vwap_20"
        operator: ">"
        value: -1.5
    action:
      command: "python ./Trading/alpaca_buy_cli.py upro 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 600

  # Trend Monitor: SPY Downtrend (Price < SMA 50 AND SMA 200)
  # Buy inverse ETF instead of shorting (cheaper, no borrow fees)
  - name: "SPY Downtrend"
    symbol: "SPY"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "close"
        operator: "<"
        value: "sma_50"
      - field: "close"
        operator: "<"
        value: "sma_200"
      - field: "rsi_21"
        operator: ">"
        value: 42.0
      - field: "rsi_21"
        operator: "<"
        value: 58.0
      - field: "z_score_vwap_20"
        operator: ">"
        value: -1.5
      - field: "z_score_vwap_20"
        operator: "<"
        value: 1.5
    action:
      # Buy SPXU (3x inverse SPY) instead of shorting UPRO
      command: "python ./Trading/alpaca_buy_cli.py spxu 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 600

  # ============================================================================
  # SPY MEAN REVERSION RULES (Dual Confirmation: RSI + Z-Score)
  # ============================================================================

  # Mean Reversion: SPY Oversold (RSI < 22 AND z-score < -2.5)
  # Counter-trend trade: requires BOTH RSI extreme AND statistical extreme
  - name: "SPY Oversold Mean Reversion"
    symbol: "SPY"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "rsi_21"
        operator: "<"
        value: 22.0
      - field: "z_score_vwap_20"
        operator: "<"
        value: -2.5
    action:
      # Extreme oversold with dual confirmation - buy the dip
      command: "python ./Trading/alpaca_buy_cli.py upro 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 2700

  # Mean Reversion: SPY Overbought (RSI > 78 AND z-score > 2.5)
  # Counter-trend trade: requires BOTH RSI extreme AND statistical extreme
  - name: "SPY Overbought Mean Reversion"
    symbol: "SPY"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "rsi_21"
        operator: ">"
        value: 78.0
      - field: "z_score_vwap_20"
        operator: ">"
        value: 2.5
    action:
      # Extreme overbought with dual confirmation - buy inverse ETF
      command: "python ./Trading/alpaca_buy_cli.py spxu 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 2700

  # ============================================================================
  # QQQ TREND RULES
  # ============================================================================

  # Trend Monitor: QQQ Uptrend (Price > SMA 50 AND SMA 200)
  # Only buy in confirmed uptrend with RSI in neutral zone and not overextended
  - name: "QQQ Uptrend"
    symbol: "QQQ"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "close"
        operator: ">"
        value: "sma_50"
      - field: "close"
        operator: ">"
        value: "sma_200"
      - field: "rsi_21"
        operator: "<"
        value: 58.0
      - field: "rsi_21"
        operator: ">"
        value: 42.0
      - field: "z_score_vwap_20"
        operator: "<"
        value: 1.5
      - field: "z_score_vwap_20"
        operator: ">"
        value: -1.5
    action:
      command: "python ./Trading/alpaca_buy_cli.py tqqq 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 600

  # Trend Monitor: QQQ Downtrend (Price < SMA 50 AND SMA 200)
  # Buy inverse ETF instead of shorting (cheaper, no borrow fees)
  - name: "QQQ Downtrend"
    symbol: "QQQ"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "close"
        operator: "<"
        value: "sma_50"
      - field: "close"
        operator: "<"
        value: "sma_200"
      - field: "rsi_21"
        operator: ">"
        value: 42.0
      - field: "rsi_21"
        operator: "<"
        value: 58.0
      - field: "z_score_vwap_20"
        operator: ">"
        value: -1.5
      - field: "z_score_vwap_20"
        operator: "<"
        value: 1.5
    action:
      # Buy SQQQ (3x inverse QQQ) instead of shorting TQQQ
      command: "python ./Trading/alpaca_buy_cli.py sqqq 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 600

  # ============================================================================
  # QQQ MEAN REVERSION RULES (Dual Confirmation: RSI + Z-Score)
  # ============================================================================

  # Mean Reversion: QQQ Oversold (RSI < 22 AND z-score < -2.5)
  # Counter-trend trade: requires BOTH RSI extreme AND statistical extreme
  - name: "QQQ Oversold Mean Reversion"
    symbol: "QQQ"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "rsi_21"
        operator: "<"
        value: 22.0
      - field: "z_score_vwap_20"
        operator: "<"
        value: -2.5
    action:
      # Extreme oversold with dual confirmation - buy the dip
      command: "python ./Trading/alpaca_buy_cli.py tqqq 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 2700

  # Mean Reversion: QQQ Overbought (RSI > 78 AND z-score > 2.5)
  # Counter-trend trade: requires BOTH RSI extreme AND statistical extreme
  - name: "QQQ Overbought Mean Reversion"
    symbol: "QQQ"
    asset_class: "stock"
    trigger: "bar"
    conditions:
      - field: "rsi_21"
        operator: ">"
        value: 78.0
      - field: "z_score_vwap_20"
        operator: ">"
        value: 2.5
    action:
      # Extreme overbought with dual confirmation - buy inverse ETF
      command: "python ./Trading/alpaca_buy_cli.py sqqq 5000 --mid-price --stop-loss-pct 0.5 --take-profit-pct 1.0"
    cooldown: 2700

  # ============================================================================
  # DATA CAPTURE (Passive Monitoring)
  # ============================================================================

  - name: "Data Capture TQQQ"
    symbol: "TQQQ"
    asset_class: "stock"
    trigger: "bar"
    condition:
      field: "close"
      operator: "<"
      value: 0.0
    action:
      command: "echo 'Data Capture'"

  - name: "Data Capture SQQQ"
    symbol: "SQQQ"
    asset_class: "stock"
    trigger: "bar"
    condition:
      field: "close"
      operator: "<"
      value: 0.0
    action:
      command: "echo 'Data Capture'"

  - name: "Data Capture SPXU"
    symbol: "SPXU"
    asset_class: "stock"
    trigger: "bar"
    condition:
      field: "close"
      operator: "<"
      value: 0.0
    action:
      command: "echo 'Data Capture'"

  - name: "Data Capture UPRO"
    symbol: "UPRO"
    asset_class: "stock"
    trigger: "bar"
    condition:
      field: "close"
      operator: "<"
      value: 0.0
    action:
      command: "echo 'Data Capture'"