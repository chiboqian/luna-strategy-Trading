# Pairs Trading: QQQ vs SPY (Mean Reversion)
# Uses 1x Inverse ETFs.
#
# STRATEGY: MEAN REVERSION
# - When QQQ is expensive (Z > 1.5), we Short QQQ (Buy PSQ) and Long SPY.
# - When QQQ is cheap (Z < -1.5), we Long QQQ and Short SPY (Buy SH).

rules:
  # ----------------------------------------------------------------------------
  # SCENARIO: QQQ IS EXPENSIVE (Z > 1.5)
  # Trade: Short QQQ (Buy PSQ) / Long SPY
  # Bet: Spread narrows (Z goes down to 0)
  # ----------------------------------------------------------------------------
  - name: "Pair Entry: Short QQQ (via PSQ) / Long SPY"
    asset_class: "stock"
    symbol: "QQQ" 
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: 1.5
    action:
      # Buy PSQ (Short QQQ) and SPY
      command: "python ./Trading/alpaca_pairs_cli.py --long SPY --short PSQ --capital 10000 --action open --type long-long --check-position"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # SCENARIO: QQQ IS CHEAP (Z < -1.5)
  # Trade: Long QQQ / Short SPY (Buy SH)
  # Bet: Spread widens (Z goes up to 0)
  # ----------------------------------------------------------------------------
  - name: "Pair Entry: Long QQQ / Short SPY (via SH)"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: -1.5
    action:
      # Buy QQQ and SH (Short SPY)
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --capital 10000 --action open --type long-long --check-position"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # PAIR EXIT: NORMALIZE (Take Profit)
  # ----------------------------------------------------------------------------
  - name: "Pair Exit: Normalize"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      # Spread has returned to normal range [-0.5, 0.5]
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: 0.5
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: -0.5
      # Only execute if we have positions to close
      - field: "position_qty"
        operator: "abs>"
        value: 0
    action:
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # STOP LOSS: BLOWOUT (Spread keeps widening against us)
  # ----------------------------------------------------------------------------
  - name: "Pair Stop: Blowout (Z > 3.0)"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      # We Shorted QQQ at 1.5, but it went to 3.0. Pain.
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: 3.0
      - field: "position_qty"
        operator: "abs>"
        value: 0
    action:
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600

  - name: "Pair Stop: Blowout (Z < -3.0)"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      # We Longed QQQ at -1.5, but it went to -3.0. Pain.
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: -3.0
      - field: "position_qty"
        operator: "abs>"
        value: 0
    action:
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600
