# Pairs Trading: QQQ vs SPY (Risk-On / Risk-Off Rotation)
# Uses 1x Inverse ETFs to avoid short selling borrowing costs.
# - PSQ = Short QQQ
# - SH  = Short SPY
#
# IMPORTANT: Run close_old_positions.py with --symbols QQQ,SH,SPY,PSQ --days 5
# to prevent inverse ETF decay from eroding returns on multi-day holds.
# Example cron: 0 15 * * * python ./Trading/stock_trading/close_old_positions.py --days 5 --symbols QQQ,SH,SPY,PSQ

rules:
  # ----------------------------------------------------------------------------
  # PAIR ENTRY: LONG TECH / SHORT MARKET
  # Logic: QQQ is Strong relative to SPY (ratio divergence).
  # Trade: Long QQQ + Long SH (Short SPY proxy)
  # ----------------------------------------------------------------------------
  - name: "Pair Entry: Long QQQ / Short SPY (via SH)"
    asset_class: "stock"
    symbol: "QQQ" 
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: 1.5
    action:
      # We buy QQQ and SH (Short SPY). Capital split 50/50.
      # --check-position prevents stacking if already in a trade
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --capital 10000 --action open --type long-long --check-position"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # PAIR ENTRY: SHORT TECH / LONG MARKET
  # Logic: QQQ is Weak relative to SPY (ratio divergence).
  # Trade: Long PSQ (Short QQQ proxy) + Long SPY
  # ----------------------------------------------------------------------------
  - name: "Pair Entry: Short QQQ (via PSQ) / Long SPY"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: -1.5
    action:
      # We buy PSQ (Short QQQ) and SPY. Capital split 50/50.
      # --check-position prevents stacking if already in a trade
      command: "python ./Trading/alpaca_pairs_cli.py --long SPY --short PSQ --capital 10000 --action open --type long-long --check-position"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # PAIR EXIT: NORMALIZE (QQQ Trigger)
  # ----------------------------------------------------------------------------
  - name: "Pair Exit: QQQ/SPY Normalize (QQQ Trigger)"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: 0.5
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: -0.5
      # Only trigger exit if we actually have a position
      - field: "position_qty"
        operator: "abs>"
        value: 0
    action:
      # Close ALL positions related to this pair
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # PAIR EXIT: NORMALIZE (SPY Trigger) - Redundant exit for robustness
  # ----------------------------------------------------------------------------
  - name: "Pair Exit: QQQ/SPY Normalize (SPY Trigger)"
    asset_class: "stock"
    symbol: "SPY"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: 0.5
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: -0.5
      # Only trigger exit if we actually have a position
      - field: "position_qty"
        operator: "abs>"
        value: 0
    action:
      # Close ALL positions related to this pair
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # STOP-LOSS: Momentum Reversal (Long QQQ Position)
  # If we're Long QQQ (entered at Z > 1.5) and momentum reverses, cut losses
  # Z dropping below 0 means QQQ is now underperforming SPY
  # ----------------------------------------------------------------------------
  - name: "Pair Stop: Long QQQ Momentum Reversal"
    asset_class: "stock"
    symbol: "QQQ"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: "<"
        value: -0.5
      # Only if we have QQQ position (from Long QQQ/Short SPY trade)
      - field: "position_qty"
        operator: ">"
        value: 0
    action:
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600

  # ----------------------------------------------------------------------------
  # STOP-LOSS: Momentum Reversal (Short QQQ Position via PSQ)
  # If we're Short QQQ via PSQ (entered at Z < -1.5) and momentum reverses, cut losses
  # Z rising above 0 means QQQ is now outperforming SPY
  # ----------------------------------------------------------------------------
  - name: "Pair Stop: Short QQQ Momentum Reversal"
    asset_class: "stock"
    symbol: "PSQ"
    trigger: "bar"
    conditions:
      - field: "z_score_ratio_QQQ_SPY_20"
        operator: ">"
        value: 0.5
      # Only if we have PSQ position (from Short QQQ/Long SPY trade)
      - field: "position_qty"
        operator: ">"
        value: 0
    action:
      command: "python ./Trading/alpaca_pairs_cli.py --long QQQ --short SH --long2 SPY --short2 PSQ --action close-all"
    cooldown: 3600
